vim-cmd hostsvc/enable_ssh
vim-cmd hostsvc/start_ssh

# Enable & start ESXi Shell
vim-cmd hostsvc/enable_esx_shell
vim-cmd hostsvc/start_esx_shell

# Set the hostname
esxcli system hostname set --fqdn=${hostname_fqdn}

#move to maintenance mode
#esxcli system maintenanceMode set --enable true

# Create a portgroup for Instance Management  
esxcfg-vswitch vSwitch0 --add-pg=pg-mgmt
esxcfg-vswitch vSwitch0 --pg=pg-mgmt --vlan=${mgmt_vlan}


# Set the vmk1 to a VLAN interface
esxcli network ip interface add --interface-name=vmk1 --portgroup-name=pg-mgmt
esxcli network ip interface ipv4 set --interface-name=vmk1 --ipv4=${new_mgmt_ip_address} --netmask=${new_mgmt_netmask}  --type=static

# Mark vmk1 for management traffic

esxcli network ip interface tag add -i vmk1 -t Management
esxcli network ip interface tag remove -i vmk0 -t Management


# Remove old vmk0
#esxcli network ip route ipv4 remove --network=default --gateway=${old_mgmt_default_gateway}
#esxcli network ip interface remove --interface-name=vmk0
esxcli network ip route ipv4 add --gateway=${new_mgmt_default_gateway} --network=default

# Restart mgmt to pick up changes

/etc/init.d/hostd restart
/etc/init.d/vpxa restart

#esxcli network ip interface remove --interface-name=vmk0

# Boot host ... not needed if the restart works...and there will be a boot when adding a PCI nic 2

#esxcli system shutdown reboot -d 60 -r "vmk0 - VLAN Nic Add"
